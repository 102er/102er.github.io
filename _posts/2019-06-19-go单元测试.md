---
layout: post
title: 'go单元测试'
date: 2019-06-19
author: blossom
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-banner.png'
tags: go 单元测试
---

> 单元测试知识，go的单元测试包运用

### 基础
开发程序最重要的一点就是测试，每个开发者必须保证代码的质量，保证输出的结果是符合预期的以及代码性能是符合上线要求的。单元测试的目的是发现程序设计或者实现
逻辑错误，通过自测把问题暴漏出来，特别是一些合作项目，我们需要尽可能的规避一些能够发现的错误，提升联测的效率。
#### 1.1 go单元测试
testing 是goland提供自动化测试的包，开发者可以很容易的进行单元测试和压力测试，配合内置的go test命令 可以很方便进行测试。
测试文件名：需要测试的文件加上 "_test.go" 后缀
测试函数名：待测试函数的名称前面加 "Test"前缀，示例：

calculate.go

    func Avg(a,b int)int{
    	if b==0{
    		return 0
    	}
    	return a/b
    }

calculate_test.go

    func TestAvg(t *testing.T) {
    	a := 4
    	b := 2
    	expected := 2
    	if r := Avg(a, b); r != expected {
    		t.Errorf("avg(%d,%d) = %d;expected %d", a, b, r, expected)
    	}
    }

执行 go test -v 可以查看测试输出结果：

      E:\go_project\src\study\test>go test -v
      === RUN   TestAvg
      --- PASS: TestAvg (0.00s)
      PASS
      ok      study/test      1.463s

日常工作，测试需要衡量有case覆盖率指标，我们通过Table-driven方式，调整下测试函数:
    
    func TestAvg(t *testing.T) {
    	var params = []struct {
    		a        int
    		b        int
    		expected int
    	}{
    		{4, 2, 2},
    		{6, 2, 3},
    		{0, 1, 0},
    		{1, 0, 0},
    		{8, 2, 4},
    		{12, 2, 6},
    	}
    	for _, v := range params {
    		if r := Avg(v.a, v.b); r != v.expected {
    			t.Errorf("avg(%d,%d) = %d;expected %d", v.a, v.b, r, v.expected)
    		}
    	}
    }
    
通过go test -cover 查看测试覆盖率
  
    E:\go_project\src\study\test>go test -cover
    PASS
    coverage: 100.0% of statements
    ok      study/test      1.229s

#### 1.1 go性能测试(基准测试)
性能测试函数以Benchmark 开头，参数类型是 *testing.B，可与Test函数放在同个文件中。
默认情况下，go test不执行Benchmark测试，必须用“-bench <pattern>”指定性能测试函数。
    
    func BenchmarkAvg(b *testing.B) {
    	for i := 0; i < b.N; i++ {
    		Avg(4, 2)
    	}
    }
测试结果如下，执行了1000000000次，每次平均执行时间是0.9纳秒：

    E:\go_project\src\study\test>go test -bench=.
    goos: windows
    goarch: amd64
    pkg: study/test
    BenchmarkAvg-4          1000000000               0.923 ns/op
    PASS
    ok      study/test      2.041s

基准测试三个计时方法：
* StartTimer：开始对测试进行计时。该方法会在基准测试开始时自动被调用，我们也可以在调用 StopTimer 之后恢复计时；
* StopTimer：停止对测试进行计时。当你需要执行一些复杂的初始化操作，并且你不想对这些操作进行测量时，就可以使用这个方法来暂时地停止计时。
* ResetTimer：对已经逝去的基准测试时间以及内存分配计数器进行清零。对于正在运行中的计时器，这个方法不会产生任何效果。
